- hosts: master
  become: yes
  tasks:

    - name: kubernetes config 1
      shell: "mkdir -p /home/ansible/.kube"
      args:
        chdir: /home/ansible
    - name: kubernetes config 2
      shell: "cp /etc/kubernetes/admin.conf /home/ansible/.kube/config"
      args:
        chdir: /home/ansible
    - name: kubernetes config 3
      shell: "chown ansible:ansible /home/ansible/.kube/config"
      args:
        chdir: /home/ansible

    - name: Upload calico.yaml to MV
      copy:
        src: ../files/custom-resources.yaml
        dest: /home/ansible/custom-resources.yaml
        owner: ansible
        group: ansible
        mode: '0664'
    - name: install tigera 2
      shell: "kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml"
      args:
        chdir: /home/ansible

    - name: install calico
      shell: "kubectl apply -f custom-resources.yaml"
      args:
        chdir: /home/ansible
    
- hosts: workers
  become: yes
  vars_prompt:
    - name: comando
      prompt: Introduce una contrase√±a para generar el hash
  
  tasks:
    - name: worker firewall 1
      shell: "firewall-cmd --zone=public --permanent --add-rich-rule 'rule family=ipv4 source address=172.17.0.0/16 accept'"
      args:
        chdir: /home/ansible
    - name: worker firewall 2
      shell: 'firewall-cmd --reload'
      args:
        chdir: /home/ansible
    - name: workers join cluter
      command: "{{ comando }}"